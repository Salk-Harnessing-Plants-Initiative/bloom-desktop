# Change Proposal: Fix Credential Flow and Use Single .env File

## Problem Statement

The current Machine Configuration implementation has three critical issues:

1. **Broken fetch scanners button**: The "Fetch Scanners from Bloom" button fails on first run because it attempts to load credentials from `.env` file before they are saved, instead of using the credentials entered in the form.

2. **Unnecessary login screen**: The application includes a login screen that validates credentials against the saved `.env` file. This contradicts the pilot implementation pattern and provides no value:
   - Scanner machines are single-purpose devices with one identity
   - Credentials are already saved locally in `.env`
   - Login screen forces users to re-enter the same credentials
   - **Pilot implementation has NO login screen** (verified in `bloom-desktop-pilot`)

3. **Redundant configuration storage**: The application stores configuration in TWO separate files, violating single source of truth:
   - `~/.bloom/config.json` - scanner_name, camera_ip_address, scans_dir, bloom_api_url
   - `~/.bloom/.env` - credentials only
   - This creates synchronization issues, duplicate load/save logic, and unclear ownership

## Context: Scanner Configuration Architecture

### Pilot Implementation Pattern

**Evidence from `bloom-desktop-pilot/app/src/main/main.ts`**:

```typescript
// Lines 86-100: Pilot stores EVERYTHING in ONE file
const config_yaml = path.join(homedir, '.bloom', 'desktop-config.yaml');
const config = yaml.load(fs.readFileSync(config_yaml, 'utf8')) as {
  python: string;
  scanner_name: string; // ← Config
  camera_ip_address: string; // ← Config
  scans_dir: string; // ← Config
  bloom_api_url: string; // ← Config
  bloom_scanner_username: string; // ← Credentials
  bloom_scanner_password: string; // ← Credentials
  bloom_anon_key: string; // ← Credentials
  // ...
};
// No separate files - single source of truth
```

**Key Insight**: Pilot treats ALL configuration as sensitive and stores it in one file.

### How Bloom API Authentication Works

**Evidence from Bloom API** (`bloom/supabase/migrations`):

```sql
-- cyl_scanners table stores scanner names only
CREATE TABLE cyl_scanners (
    id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    name TEXT
);

-- Row-level security: requires Supabase authentication
CREATE POLICY "Authenticated users can select cyl_scanners"
ON cyl_scanners FOR SELECT TO authenticated USING (true);
```

**Authentication Flow**:

1. Desktop app uses Supabase `signInWithPassword()` with stored credentials
2. Supabase returns JWT token
3. All API calls (including future uploads) use this authenticated session
4. Credentials represent a **service account** for the scanner machine, not a human user

**Why ALL Configuration Must Be Persisted**:

- Scanner needs persistent identity (scanner_name, camera_ip, etc.)
- Scanner needs to upload scan data to Bloom API (future feature)
- Uploads require authenticated Supabase session
- Scanner operates autonomously after initial setup
- No human user present during scanning operations

## Root Cause Analysis

The credential architecture violates "single source of truth" principle:

1. **Credentials saved to `~/.bloom/.env`** during configuration
2. **Login screen requires re-entry** of same credentials for validation
3. **Fetch scanners IPC handler** loads from file, not form input
4. Creates unnecessary friction in first-run experience
5. **Contradicts pilot pattern** which has no login screen

## Proposed Solution

### 1. Remove Login Screen (Match Pilot Pattern)

**Pilot Evidence** (`bloom-desktop-pilot/app/src/main/main.ts`):

```typescript
// Lines 86-100: Pilot loads config on startup
const config_yaml = path.join(homedir, '.bloom', 'desktop-config.yaml');
const config = yaml.load(fs.readFileSync(config_yaml, 'utf8')) as {
  python: string;
  scanner_name: string;
  bloom_scanner_username: string; // Loaded directly
  bloom_scanner_password: string; // No re-authentication
  bloom_anon_key: string;
  // ...
};
// App proceeds directly - NO LOGIN SCREEN
```

**New Flow**:

```
App Startup:
├─ Load ~/.bloom/.env (if exists) - contains ALL config + credentials
└─ Show Configuration Form
   ├─ Pre-filled with saved values
   ├─ User can modify and save
   └─ No separate authentication step
```

### 2. Fix Fetch Scanners to Accept Form Credentials

**Current (broken)**:

```typescript
// src/main/main.ts:940
ipcMain.handle('config:fetch-scanners', async () => {
  const credentials = loadCredentials(ENV_PATH); // ❌ Empty on first run!
  // ...
});
```

**Fixed**:

```typescript
ipcMain.handle(
  'config:fetch-scanners',
  async (_event, apiUrl: string, credentials: MachineCredentials) => {
    // ✅ Uses credentials from form, works on first run
    return await fetchScannersFromBloom(apiUrl, credentials);
  }
);
```

**Renderer Update**:

```typescript
// src/renderer/MachineConfiguration.tsx
const fetchScanners = async () => {
  setScannerListLoading(true);
  try {
    // ✅ Pass form credentials as parameters
    const result = await window.electron.config.fetchScanners(
      config.bloom_api_url,
      credentials
    );
    // ...
  }
};
```

### 3. Consolidate to Single `.env` File (Match Pilot Pattern)

**Pilot stores everything in one file**, we should too:

**Remove**: `~/.bloom/config.json` (eliminates redundant storage)
**Keep**: `~/.bloom/.env` as single source of truth for ALL configuration

**Why consolidate?**

- ✅ Matches pilot implementation pattern (single YAML file)
- ✅ Eliminates synchronization issues between two files
- ✅ Simpler code (one load/save function instead of two)
- ✅ Scanner config and credentials logically belong together
- ✅ Both are equally sensitive (machine identity)
- ✅ Consistent file permissions (600) for all config

**New `.env` File Structure** (single source of truth):

```env
# Machine Configuration
SCANNER_NAME=PBIOBScanner
CAMERA_IP_ADDRESS=10.0.0.50
SCANS_DIR=/Users/scanner/.bloom/scans
BLOOM_API_URL=https://api.bloom.salk.edu/proxy

# Bloom API Credentials (Supabase service account)
BLOOM_SCANNER_USERNAME=pbiob_scanner@salk.edu
BLOOM_SCANNER_PASSWORD=<machine-password>
BLOOM_ANON_KEY=<supabase-anon-key>
```

**Configuration Functions** (simplified):

```typescript
// BEFORE: Two separate functions
loadConfig(CONFIG_PATH); // Loads config.json
loadCredentials(ENV_PATH); // Loads .env

// AFTER: Single unified function
loadEnvConfig(ENV_PATH); // Loads everything from .env
```

## Scope

### Files to Modify

1. **src/main/config-store.ts** (NEW - major refactor):
   - Remove `loadConfig()` and `saveConfig()` functions
   - Remove `loadCredentials()` and `saveCredentials()` functions
   - Add unified `loadEnvConfig()` to read all from `.env`
   - Add unified `saveEnvConfig()` to write all to `.env`
   - Update `MachineConfig` interface to include all fields
   - Remove `MachineCredentials` interface (merge into `MachineConfig`)
   - Remove `CONFIG_PATH` constant (no more config.json)

2. **src/main/main.ts**:
   - Update `config:load` handler to use `loadEnvConfig()`
   - Update `config:save` handler to use `saveEnvConfig()`
   - Update `config:fetch-scanners` handler to accept parameters
   - Remove `config:validate-credentials` handler

3. **src/main/preload.ts**:
   - Update `fetchScanners` to accept `apiUrl` and `credentials`
   - Remove `validateCredentials` API
   - Update `load()` and `save()` to handle unified config

4. **src/types/electron.d.ts**:
   - Update `MachineConfig` interface to include credential fields
   - Remove `MachineCredentials` interface
   - Update `fetchScanners` type signature
   - Remove `validateCredentials` type
   - Update `ConfigAPI.load()` return type

5. **src/renderer/MachineConfiguration.tsx**:
   - Merge `config` and `credentials` state into single `config` state
   - Remove login screen UI (`formState === 'login'`)
   - Remove `loginUsername`, `loginPassword`, `loginError` state
   - Remove `handleLogin` function
   - Simplify `formState` to `'loading' | 'config'`
   - Update `fetchScanners` to pass form credentials from unified state
   - Update load/save logic to work with single config object

6. **tests/unit/config-ipc.test.ts**:
   - Add test: `config:fetch-scanners` accepts parameters
   - Add test: Handler uses provided credentials, not file
   - Remove tests for `config:validate-credentials`
   - Update tests for unified config load/save

7. **tests/unit/config-store.test.ts**:
   - Update tests for `loadEnvConfig()` instead of `loadConfig()`
   - Update tests for `saveEnvConfig()` instead of `saveConfig()`
   - Remove separate credential tests (now part of unified config)

8. **tests/unit/pages/MachineConfiguration.test.tsx**:
   - Remove login screen tests
   - Update fetch scanners tests to verify parameters passed
   - Update load tests to expect config form, not login
   - Update tests to work with unified config state

9. **tests/e2e/machine-config-fetch-scanners.e2e.ts**:
   - Update to match new flow (no login screen)
   - Add test for first-run fetch scanners
   - Update tests to work with unified config state

### Files to Delete

- **~/.bloom/config.json** (replaced by .env)
- Any code that references `CONFIG_PATH` constant

## Benefits

1. **Fixes critical bug**: Fetch scanners works on first run
2. **Matches pilot pattern**: Aligns with proven implementation (single YAML file)
3. **Simpler UX**: Removes unnecessary authentication step
4. **True single source of truth**: One `.env` file for ALL configuration
5. **Eliminates synchronization issues**: No config.json vs .env conflicts
6. **Simpler code**: One load/save function instead of two
7. **Faster workflow**: Direct access to configuration
8. **Maintains security**: Credentials still persisted for uploads
9. **Clearer purpose**: All scanner identity in one place

## Impact Analysis

### Breaking Changes

- ❌ **Removes**: Login screen UI
- ❌ **Removes**: `config:validate-credentials` IPC handler
- ❌ **Removes**: `validateCredentials` Electron API
- ❌ **Removes**: `config.json` file (consolidated into `.env`)
- ❌ **Removes**: `MachineCredentials` interface (merged into `MachineConfig`)
- ❌ **Removes**: Separate `loadConfig()` and `loadCredentials()` functions
- ⚠️ **Changes**: `fetchScanners` API signature (adds parameters)
- ⚠️ **Changes**: `MachineConfig` interface (now includes credential fields)
- ⚠️ **Changes**: Component state management (merged config + credentials)

### Non-Breaking Changes

- ✅ **Keeps**: All configuration data (moved to `.env`)
- ✅ **Keeps**: Credential persistence (still in `.env`)
- ✅ **Improves**: First-run experience
- ✅ **Improves**: Configuration management (single source of truth)
- ✅ **Adds**: Parameters to `config:fetch-scanners`

### Migration Path

**Automatic migration on first load**:

1. App checks for existing `~/.bloom/config.json`
2. If found, reads both `config.json` and `.env`
3. Merges into single `.env` file
4. Deletes `config.json`
5. Future loads read only from `.env`

**User impact**: Zero - migration happens transparently on startup.

**Code Migration**: Unit tests need updates for:

- New unified config interfaces
- Single load/save functions
- Merged component state

## Testing Strategy

### Unit Tests (TDD Approach)

1. **IPC Handler Tests** (`config-ipc.test.ts`):

   ```typescript
   describe('config:fetch-scanners handler logic', () => {
     it('should accept apiUrl and credentials as parameters', async () => {
       const apiUrl = 'https://api.bloom.salk.edu/proxy';
       const credentials = {
         /* ... */
       };

       const result = await handler(apiUrl, credentials);

       expect(result.success).toBe(true);
       expect(result.scanners).toBeDefined();
     });

     it('should NOT load credentials from file', async () => {
       // Verify file loading functions not called
     });
   });
   ```

2. **Component Tests** (`MachineConfiguration.test.tsx`):

   ```typescript
   it('should not render login screen', () => {
     render(<MachineConfiguration />);
     expect(screen.queryByText(/Enter Credentials to access/i)).not.toBeInTheDocument();
   });

   it('should pass form credentials to fetchScanners', async () => {
     const mockFetchScanners = vi.fn();
     window.electron.config.fetchScanners = mockFetchScanners;

     render(<MachineConfiguration />);
     // Fill form...
     fireEvent.click(screen.getByText(/Fetch Scanners from Bloom/i));

     expect(mockFetchScanners).toHaveBeenCalledWith(
       expect.any(String), // apiUrl
       expect.objectContaining({ // credentials
         bloom_scanner_username: expect.any(String),
         bloom_scanner_password: expect.any(String),
         bloom_anon_key: expect.any(String),
       })
     );
   });
   ```

### E2E Tests

1. **First-Run Flow**:
   - Start app with no `~/.bloom/` directory
   - Verify configuration form shown (not login)
   - Enter ALL config fields (scanner name, camera IP, scans dir, API URL, credentials)
   - Click "Fetch Scanners" → verify success
   - Save configuration → verify saved to `.env` only

2. **Returning User Flow**:
   - Start app with existing `~/.bloom/.env`
   - Verify form pre-filled with ALL saved values
   - Verify no login screen shown
   - Modify credentials
   - Fetch scanners → verify uses new values

3. **Migration Test** (config.json → .env):
   - Create old-style `config.json` + `.env` files
   - Start app
   - Verify all values loaded correctly
   - Verify `config.json` deleted after migration
   - Verify all data now in `.env`

### Manual Testing Checklist

```bash
# 1. Clean slate test
rm -rf ~/.bloom/
npm start
# Expected: Configuration form shown immediately
# Fill in credentials and click "Fetch Scanners"
# Expected: Scanner list populates

# 2. Save and restart test
# Click "Save Configuration"
# Restart app
# Expected: Form pre-filled, no login screen

# 3. Modify credentials test
# Change password in form
# Click "Fetch Scanners" (don't save yet)
# Expected: Uses NEW password from form, not saved one
```

## Implementation Phases

### Phase 1: Write Tests First (TDD)

1. ✅ Add IPC handler tests for parameterized `config:fetch-scanners`
2. ✅ Add component tests for passing credentials
3. ✅ Remove login screen tests
4. ✅ Run tests → expect failures

### Phase 2: Fix Fetch Scanners IPC Handler

1. Update `src/main/main.ts` handler signature
2. Update `src/main/preload.ts` to pass parameters
3. Update `src/types/electron.d.ts` types
4. Run tests → verify IPC tests pass

### Phase 3: Update Renderer

1. Update `fetchScanners` in `MachineConfiguration.tsx`
2. Pass `config.bloom_api_url` and `credentials`
3. Run tests → verify component tests pass

### Phase 4: Remove Login Screen

1. Remove `formState = 'login'` logic
2. Remove login state variables
3. Remove login UI render
4. Remove `handleLogin` function
5. Update load logic to skip `hasCredentials` check
6. Run all tests → verify pass

### Phase 5: E2E Testing

1. Run E2E test suite
2. Manual first-run testing
3. Manual returning-user testing
4. Verify fetch button works in both scenarios

## Acceptance Criteria

- ✅ No login screen shown on any app start
- ✅ Configuration form loads immediately with saved values (if exist)
- ✅ "Fetch Scanners" button works on first run (no saved credentials)
- ✅ "Fetch Scanners" button uses form credentials, not file
- ✅ Credentials still saved to `.env` for future upload functionality
- ✅ All unit tests pass (30+ tests expected)
- ✅ All E2E tests pass (7 tests in machine-config-fetch-scanners.e2e.ts)
- ✅ Manual testing confirms improved UX
- ✅ Matches pilot implementation pattern

## Alternatives Considered

### Alternative 1: Keep Login Screen, Fix Fetch Button Only

**Rejected**: Login screen serves no purpose and contradicts pilot pattern. Would leave technical debt.

### Alternative 2: Use OS Keychain for Credentials

**Deferred**: Adds complexity. Plain text `.env` is acceptable because:

- Scanner machines are physically secured
- Matches pilot implementation (YAML)
- Credentials are for service account, not human user
- Can be enhanced later without breaking changes

### Alternative 3: Add PIN/Passcode for Machine Access

**Deferred**: Not needed for MVP. If access control required later:

- Use OS-level authentication (Windows/Mac login)
- Or add simple numeric PIN (not credential-based)
- Independent of Supabase scanner identity

### Alternative 4: Keep Login as "Access Control"

**Rejected**: Flawed reasoning:

- If credentials are on disk, login provides no security
- Anyone with file access can read `.env`
- OS-level security is proper approach
- Login screen is security theater

## Dependencies

- **Current proposal**: `add-fetch-scanners-button` (already complete)
- **Blocks**: Future Bloom upload implementation (needs credentials available)
- **Blocked by**: None

## Rollback Plan

If issues discovered post-merge:

1. Revert commit restores login screen
2. Fetch button bug remains fixed (parameterized IPC)
3. No data loss (`.env` files unchanged)
4. Re-evaluate login screen purpose with team

## Documentation Updates

1. Update README.md to remove login screen from workflow
2. Add comment in `config-store.ts` explaining credential purpose
3. Update E2E testing docs if needed

## Security Considerations

**Current State** (with login):

- Credentials in plain text `.env`
- Login screen validates against same file
- Provides illusion of security, not actual security

**New State** (without login):

- Credentials in plain text `.env` (unchanged)
- No login screen
- **Same security posture**, clearer UX

**Actual Security**:

- File permissions (600) on `.env`
- OS-level access control
- Physical security of scanner machines
- Row-level security in Supabase (authenticated role)

## Future Enhancements

1. **OS Keychain Integration**: Move from `.env` to encrypted storage
2. **Credential Rotation**: Add UI to update scanner credentials
3. **Upload Implementation**: Use saved credentials for Bloom API uploads
4. **Audit Logging**: Track credential usage for security monitoring
